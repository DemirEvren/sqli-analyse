apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: monitoring

# Install kube-prometheus-stack via Helm
helmCharts:
  - name: kube-prometheus-stack
    repo: https://prometheus-community.github.io/helm-charts
    version: 61.3.1
    releaseName: monitoring-stack
    namespace: monitoring
    valuesInline:
      prometheus:
        prometheusSpec:
          retention: 30d
          storageSpec:
            volumeClaimTemplate:
              spec:
                accessModes: ["ReadWriteOnce"]
                resources:
                  requests:
                    storage: 20Gi
          serviceMonitorSelectorNilUsesHelmValues: false
          podMonitorSelectorNilUsesHelmValues: false
      grafana:
        adminPassword: admin
        persistence:
          enabled: true
          size: 5Gi
      alertmanager:
        enabled: true
      nodeExporter:
        enabled: true
      kubeStateMetrics:
        enabled: true
      prometheusOperator:
        enabled: true

# Apply ServiceMonitor for backend metrics
resources:
  - servicemonitor.yaml
  - grafana-dashboard.yaml
