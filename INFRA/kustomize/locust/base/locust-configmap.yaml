apiVersion: v1
kind: ConfigMap
metadata:
  name: locust-config
data:
  locustfile.py: |
    import os
    from locust import HttpUser, task, between

    # BASE_URL can be:
    # - "http://192.168.97.4:80" - ingress IP (preferred for multi-cluster setup)
    # - "http://localhost:8080" - localhost with port-forward (for local testing)
    # - "http://shelfware.local:80" - direct domain (if DNS configured)
    BASE_URL = os.getenv(
        "BASE_URL",
        "http://192.168.97.4"
    )

    TARGET_ENV = os.getenv("TARGET_ENV", "prod").lower()
    DEFAULT_HOSTS = {"prod": "shelfware.local", "test": "test.shelfware.local"}
    HOST_HEADER = os.getenv("HOST_HEADER", DEFAULT_HOSTS.get(TARGET_ENV, "shelfware.local"))

    class ShelfwareUser(HttpUser):
        host = BASE_URL
        wait_time = between(0.5, 2.0)

        def on_start(self):
            self.client.headers.update({"Host": HOST_HEADER, "User-Agent": "locust"})

        @task(10)
        def root(self):
            with self.client.get("/", name="GET /", catch_response=True) as response:
                # Frontend returns HTML (200), which is success
                if response.status_code == 200:
                    response.success()
                else:
                    response.failure(f"Unexpected status: {response.status_code}")

        @task(5)
        def get_projects(self):
            self.client.get("/api/projects", name="GET /api/projects")

        @task(2)
        def health(self):
            self.client.get("/health", name="GET /health")
