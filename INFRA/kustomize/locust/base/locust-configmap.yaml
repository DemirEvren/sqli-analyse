apiVersion: v1
kind: ConfigMap
metadata:
  name: locust-config
data:
  locustfile.py: |
    import os
    from locust import HttpUser, task, between

    BASE_URL = os.getenv(
        "BASE_URL",
        "http://k3d-shelfware-app-serverlb"
    )

    TARGET_ENV = os.getenv("TARGET_ENV", "prod").lower()
    DEFAULT_HOSTS = {"prod": "shelfware.local", "test": "test.shelfware.local"}
    HOST_HEADER = os.getenv("HOST_HEADER", DEFAULT_HOSTS.get(TARGET_ENV, "shelfware.local"))

    class ShelfwareUser(HttpUser):
        host = BASE_URL
        wait_time = between(0.5, 2.0)

        def on_start(self):
            self.client.headers.update({"Host": HOST_HEADER, "User-Agent": "locust"})

        @task(10)
        def root(self):
            self.client.get("/", name="GET /")

        @task(2)
        def health(self):
            self.client.get("/health", name="GET /health", allow_redirects=False)
